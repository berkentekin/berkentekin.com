---
import { getCollection, render } from "astro:content";
import Layout from "../../layouts/Layout.astro";
import LikeButton from "../../components/LikeButton";

const { slug } = Astro.params;
const posts = await getCollection("posts");

const personalPosts = posts
    .filter(
        (post) =>
            post.data.category === "personal" ||
            post.data.category === "essay" ||
            post.data.category === "story" ||
            !post.data.category,
    )
    .sort((a, b) => {
        if (a.data.date && b.data.date) {
            return (
                new Date(b.data.date).getTime() -
                new Date(a.data.date).getTime()
            );
        }
        if (a.data.date) return -1;
        if (b.data.date) return 1;
        return 0;
    });

const post = personalPosts.find((p) => p.id.replace(/\.[^/.]+$/, "") === slug);

if (!post) {
    return Astro.redirect("/404");
}

const { Content } = await render(post);
---

<Layout title={post.data.title}>
    <div class="flex flex-col md:flex-row min-h-screen">
        {/* Sidebar - Reused for consistency */}
        <aside
            class="w-full md:w-1/3 border-r border-black dark:border-zinc-700 p-8 md:h-screen md:sticky md:top-0 overflow-y-auto bg-white dark:bg-zinc-900 z-10 hidden md:block"
        >
            <header class="mb-12">
                <h1 class="text-4xl font-black mb-2 tracking-tighter">
                    Personal
                </h1>
                <a
                    href="/"
                    class="text-sm font-bold tracking-normal hover:underline"
                    >&larr; Back Home</a
                >
            </header>

            <div class="space-y-6">
                {
                    personalPosts.map((p) => (
                        <article class="group mb-4">
                            <a
                                href={`/personal/${p.id.replace(/\.[^/.]+$/, "")}`}
                                class={`block ${p.id === post.id ? "opacity-100" : "opacity-60 hover:opacity-100 transition-opacity"}`}
                            >
                                <h2
                                    class={`text-xl font-bold mb-1 group-hover:underline decoration-1 underline-offset-4 leading-tight ${p.id === post.id ? "underline decoration-2" : ""}`}
                                >
                                    {p.data.title}
                                </h2>
                                {p.data.date && (
                                    <p class="text-xs text-gray-500 dark:text-gray-400 font-serif italic">
                                        {new Date(
                                            p.data.date,
                                        ).toLocaleDateString("nl-NL", {
                                            year: "numeric",
                                            month: "2-digit",
                                            day: "2-digit",
                                        })}
                                    </p>
                                )}
                            </a>
                        </article>
                    ))
                }
            </div>
        </aside>

        {/* Mobile Header for context */}
        <div
            class="md:hidden p-4 border-b border-black dark:border-zinc-700 bg-white dark:bg-zinc-900"
        >
            <a
                href="/personal"
                class="text-sm font-bold uppercase tracking-widest hover:underline"
                >&larr; All Stories</a
            >
        </div>

        {/* Main Content Area */}
        <main
            class="w-full md:w-2/3 p-8 md:p-12 bg-white dark:bg-zinc-900 min-h-screen"
        >
            <article
                class="prose prose-neutral dark:prose-invert prose-lg max-w-none prose-headings:font-bold prose-headings:text-black dark:prose-headings:text-white"
            >
                <h1
                    class="text-5xl font-black text-black dark:text-white leading-tight mb-8 hidden md:block"
                >
                    {post.data.title}
                </h1>
                {/* Mobile Title */}
                <h1
                    class="text-4xl font-black text-black dark:text-white leading-tight mb-8 md:hidden"
                >
                    {post.data.title}
                </h1>

                {
                    post.data.date && (
                        <p class="text-sm text-gray-500 dark:text-gray-400 font-serif italic mb-8 -mt-6">
                            {new Date(post.data.date).toLocaleDateString(
                                "nl-NL",
                                {
                                    year: "numeric",
                                    month: "2-digit",
                                    day: "2-digit",
                                },
                            )}
                        </p>
                    )
                }

                {
                    post.data.coverImage && (
                        <img
                            src={post.data.coverImage}
                            alt={post.data.title}
                            class="w-full h-auto object-cover mb-8 grayscale"
                        />
                    )
                }

                <div
                    class="font-serif text-lg leading-relaxed text-gray-800 dark:text-gray-200"
                >
                    <Content />
                </div>

                {
                    post.data.uuid && (
                        <div class="fixed bottom-8 right-8 z-50">
                            <LikeButton
                                client:only="react"
                                id={post.data.uuid}
                            />
                        </div>
                    )
                }
            </article>
        </main>
    </div>
</Layout>
