---
import { ClientRouter } from "astro:transitions";
interface Props {
	title: string;
	description?: string;
}

const { title, description = "One person among billions" } = Astro.props;
import "../styles/global.css";
import "@fontsource/lusitana/400.css";
import "@fontsource/lusitana/700.css";
---

<!doctype html>
<html lang="en" class="scrollbar-gutter-stable">
	<head>
		<meta charset="UTF-8" />
		<meta name="description" content={description} />
		<meta name="viewport" content="width=device-width" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="generator" content={Astro.generator} />
		<title>{title}</title>
		<ClientRouter />
		<script is:inline>
			const getTheme = () => {
				if (
					typeof localStorage !== "undefined" &&
					localStorage.getItem("theme")
				) {
					return localStorage.getItem("theme");
				}
				if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
					return "dark";
				}
				return "light";
			};
			if (getTheme() === "dark") {
				document.documentElement.classList.add("dark");
			} else {
				document.documentElement.classList.remove("dark");
			}
		</script>
	</head>
	<body
		class="bg-white text-black dark:bg-zinc-900 dark:text-zinc-100 font-serif antialiased transition-colors duration-300"
	>
		<nav
			id="main-nav"
			class="fixed w-full top-0 z-50 md:relative bg-white/80 dark:bg-zinc-900/80 backdrop-blur-md border-b border-gray-300 dark:border-zinc-700 py-4 transition-transform duration-300"
		>
			<div
				class="max-w-5xl mx-auto px-4 flex items-center justify-between gap-4"
			>
				<a
					id="header-name"
					href="/"
					class="font-black text-3xl tracking-normal decoration-wavy underline-offset-4 decoration-1"
				>
					Berken <span class="hidden sm:inline">Tekin</span>
				</a>
				<div class="flex items-center gap-x-8">
					<a
						href="/personal"
						class="text-base font-bold tracking-normal hover:underline"
						>Personal</a
					>
					<a
						href="/professional"
						class="text-base font-bold tracking-normal hover:underline"
						>Professional</a
					>

					<div class="relative ml-2" id="settings-menu">
						<button
							id="settings-toggle"
							class="text-gray-400 hover:text-black dark:hover:text-white transition-colors cursor-pointer p-1"
							aria-label="Settings"
						>
							<svg
								xmlns="http://www.w3.org/2000/svg"
								width="20"
								height="20"
								viewBox="0 0 24 24"
								fill="none"
								stroke="currentColor"
								stroke-width="2"
								stroke-linecap="round"
								stroke-linejoin="round"
								class="lucide lucide-settings"
							>
								<path
									d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"
								></path>
								<circle cx="12" cy="12" r="3"></circle>
							</svg>
						</button>

						<div
							id="settings-dropdown"
							class="absolute right-0 top-full mt-2 w-48 bg-white dark:bg-zinc-800 border border-gray-200 dark:border-zinc-700 shadow-xl rounded-lg overflow-hidden hidden transform origin-top-right transition-all duration-200 z-50"
						>
							<div class="p-1">
								<button
									id="theme-toggle"
									class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-zinc-700 rounded-md flex items-center gap-2"
								>
									<span
										class="dark:hidden flex items-center gap-2"
									>
										<svg
											xmlns="http://www.w3.org/2000/svg"
											width="16"
											height="16"
											viewBox="0 0 24 24"
											fill="none"
											stroke="currentColor"
											stroke-width="2"
											stroke-linecap="round"
											stroke-linejoin="round"
											class="lucide lucide-moon"
											><path
												d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"
											></path></svg
										>
										Dark Mode
									</span>
									<span
										class="hidden dark:flex items-center gap-2"
									>
										<svg
											xmlns="http://www.w3.org/2000/svg"
											width="16"
											height="16"
											viewBox="0 0 24 24"
											fill="none"
											stroke="currentColor"
											stroke-width="2"
											stroke-linecap="round"
											stroke-linejoin="round"
											class="lucide lucide-sun"
											><circle cx="12" cy="12" r="4"
											></circle><path d="M12 2v2"
											></path><path d="M12 20v2"
											></path><path
												d="m4.93 4.93 1.41 1.41"
											></path><path
												d="m17.66 17.66 1.41 1.41"
											></path><path d="M2 12h2"
											></path><path d="M20 12h2"
											></path><path
												d="m6.34 17.66-1.41 1.41"
											></path><path
												d="m19.07 4.93-1.41 1.41"
											></path></svg
										>
										Light Mode
									</span>
								</button>
								<a
									href="/keystatic"
									class="px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-zinc-700 rounded-md flex items-center gap-2"
								>
									<svg
										xmlns="http://www.w3.org/2000/svg"
										width="16"
										height="16"
										viewBox="0 0 24 24"
										fill="none"
										stroke="currentColor"
										stroke-width="2"
										stroke-linecap="round"
										stroke-linejoin="round"
										class="lucide lucide-user"
										><path
											d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"
										></path><circle cx="12" cy="7" r="4"
										></circle></svg
									>
									Admin Panel
								</a>
								<a
									href="https://github.com/berkentekin/berkentekin.com"
									target="_blank"
									rel="noopener noreferrer"
									class="px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-zinc-700 rounded-md flex items-center gap-2"
								>
									<svg
										xmlns="http://www.w3.org/2000/svg"
										width="16"
										height="16"
										viewBox="0 0 24 24"
										fill="none"
										stroke="currentColor"
										stroke-width="2"
										stroke-linecap="round"
										stroke-linejoin="round"
										class="lucide lucide-github"
										><path
											d="M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36-.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4"
										></path><path d="M9 18c-4.51 2-5-2-7-2"
										></path></svg
									>
									Source code
								</a>
							</div>
						</div>
					</div>
				</div>
			</div>
		</nav>
		<main class="max-w-5xl mx-auto px-4 py-12 pt-28 md:pt-12">
			<slot />
		</main>

		<script>
			// Define stable handlers
			const closeMenu = (e: MouseEvent) => {
				const settingsToggle: HTMLElement | null =
					document.getElementById("settings-toggle");
				const settingsDropdown: HTMLElement | null =
					document.getElementById("settings-dropdown");
				if (
					settingsToggle &&
					settingsDropdown &&
					e.target instanceof Node &&
					!settingsToggle.contains(e.target) &&
					!settingsDropdown.contains(e.target)
				) {
					settingsDropdown.classList.add("hidden");
				}
			};

			let lastScrollY = window.scrollY;
			const handleScroll = () => {
				const nav = document.getElementById("main-nav");
				// Only apply on mobile/tablet where nav is fixed
				if (window.innerWidth >= 768) {
					nav?.classList.remove("-translate-y-full");
					return;
				}

				const currentScrollY = window.scrollY;

				// Hide on scroll down, show on scroll up
				if (currentScrollY > lastScrollY && currentScrollY > 50) {
					nav?.classList.add("-translate-y-full");
				} else {
					nav?.classList.remove("-translate-y-full");
				}

				lastScrollY = currentScrollY;
			};

			function init() {
				const settingsToggle =
					document.getElementById("settings-toggle");
				const settingsDropdown =
					document.getElementById("settings-dropdown");
				const themeToggle = document.getElementById("theme-toggle");

				if (settingsToggle && settingsDropdown) {
					// Toggle menu on click
					settingsToggle.onclick = (e) => {
						e.stopPropagation();
						settingsDropdown.classList.toggle("hidden");
					};

					// Manage document listener (remove then add to ensure no duplicates)
					document.removeEventListener("click", closeMenu);
					document.addEventListener("click", closeMenu);
				}

				if (themeToggle) {
					themeToggle.onclick = (e) => {
						e.stopPropagation();
						const isDark =
							document.documentElement.classList.toggle("dark");
						localStorage.setItem(
							"theme",
							isDark ? "dark" : "light",
						);
					};
				}

				// Reset lastScrollY on navigation
				lastScrollY = window.scrollY;
				// Add scroll listener (deduplicated by function reference)
				window.addEventListener("scroll", handleScroll, {
					passive: true,
				});
			}

			function setDarkMode() {
				const theme = localStorage.getItem("theme");
				const systemDark = window.matchMedia(
					"(prefers-color-scheme: dark)",
				).matches;

				if (theme === "dark" || (!theme && systemDark)) {
					document.documentElement.classList.add("dark");
				} else {
					document.documentElement.classList.remove("dark");
				}
			}

			// Run on initial load
			init();

			// Run on View Transitions navigation
			document.addEventListener("astro:page-load", init);

			// Ensure theme persistence immediately after swap
			document.addEventListener("astro:after-swap", setDarkMode);
		</script>
	</body>
</html>
